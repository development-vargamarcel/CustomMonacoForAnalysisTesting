<!DOCTYPE html>
<html>

<head>
    <title>Local Monaco Editor</title>
    <style>
        #editor-container {
            width: 100%;
            height: 100vh;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div id="editor-container"></div>

    <!-- Local Monaco Loader -->
    <script src="FormattersPlain/sql-formatter.min.js"></script>
    <script src="FormattersPlain/vbPretty.js"></script>
    <script src="ExampleEditorString.js"></script>
    <script src="monaco-editor/vs/loader.js"></script>

    <script>
        // Configure Monaco to use local files
        require.config({
            paths: {
                vs: 'monaco-editor/vs'
            }
        });

        //questo esempio "registra" un "formatter" nel editor monaco,permettendo di usare le funzioni built-in per eseguire la formattazione e permette di mantenere la posizione del cursore.
        //pensavo di fornire una configurazione in base al linguaggio utilizzato.In questo modo l'unica cosa che deve esere diversa quando voglio creare un editor per un altro liguaggio,sarà quest'oggetto
        const VBconfig = {
            language: "vb",
            formatter: (inputString) => {
                var sourcePretty = vbspretty({
                    level: 0,
                    indentChar: '\t',
                    breakLineChar: '\r\n',
                    breakOnSeperator: false,
                    removeComments: false,
                    source: inputString,
                });
                return sourcePretty
            },
            testSource: source2VB //source1SQL è una stringa contenente il codice vb da formattare,TODO: cancellare questa riga prima di andare in produzione
        }
        const SQLconfig = {
            language: "sql",
            formatter: (inputString) => {
                return window.sqlFormatter.format(inputString);
            },
            testSource: source1SQL  //source1SQL è una stringa contenente il codice sql da formattare,TODO: cancellare questa riga prima di andare in produzione
        }
        const config = SQLconfig;
        var editorValue = config.testSource; //TODO: cancellare questa riga prima di andare in produzione





        /////////////
        // Load the editor main module
        require(['vs/editor/editor.main'], function () {
            // Initialize editor
            const editor = monaco.editor.create(
                document.getElementById('editor-container'),
                {
                    value: editorValue,
                    language: config.language,//uso la configurazione                    
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: {
                        enabled: true
                    },
                    scrollBeyondLastLine: false,
                    formatOnType: true,
                }
            );

            // Optional: Handle window resize
            window.addEventListener('resize', () => {
                editor.layout();
            });

            /////////////
            //qua aggiungo il formatter specificando per quale linguaggio verrà abilitato (al clickDestro su editor o premmendo shift alt F) e la funzione che eseguira la formattazione
            monaco.languages.registerDocumentFormattingEditProvider(config.language, { //uso la configurazione
                provideDocumentFormattingEdits: function (model, options, token) {
                    const formattedText = config.formatter(model.getValue());//uso la configurazione
                    return [
                        {
                            range: model.getFullModelRange(),
                            text: formattedText,
                        },
                    ];
                },
            });

            /////////
            //////////////
            // monaco.languages.registerDocumentFormattingEditProvider(config.language, {
            //     provideDocumentFormattingEdits: function (model, options, token) {
            //         const selections = editor.getSelections(); // Get the selected ranges
            //         const edits = [];
            //         console.log({ selections });
            //         // Loop through all selections and apply formatting to each one
            //         selections.forEach(selection => {
            //             const selectedText = model.getValueInRange(selection); // Get text in selection
            //             const formattedText = config.formatter(selectedText); // Format the selected text
            //             console.log({ selection, selectedText, formattedText });
            //             edits.push({
            //                 range: selection, // Use the selection range
            //                 text: formattedText, // Use the formatted text
            //             });
            //         });

            //         return edits;
            //     },
            // });
            ////////////

            //////////---
            editor.addAction({
                id: 'format-selected-text',
                label: 'Format Selected',
                contextMenuGroupId: 'navigation',
                contextMenuOrder: 1,
                run: function () {
                    const selections = editor.getSelections();
                    if (selections.length === 0) {
                        console.log("Nessun testo da formattare.");
                        return;
                    }

                    const model = editor.getModel();
                    const edits = [];
                    selections.forEach(selection => {
                        const selectedText = model.getValueInRange(selection);
                        const formattedText = config.formatter(selectedText);
                        console.log({ selectedText, formattedText });
                        edits.push({
                            range: selection,
                            text: formattedText,
                        });
                    });


                    model.pushEditOperations(selections, edits.map(edit => ({
                        range: edit.range,
                        text: edit.text,
                    })), () => null);
                }
            });

            //shift + f

            /////////--

        });
    </script>
</body>

</html>